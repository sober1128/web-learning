# 前端性能优化方案
前端资源比较庞大，包括`HTML`、`CSS`、`JavaScript`、`image`、`flash`、`media`等等，前端优化相对比较复杂，对于各种资源的优化有不同的方式，第一类是页面级别的优化，例如：减小`HTTP`请求数、脚本的无阻塞加载、内联脚本的位置游花灯，第二类是代码级别的优化，例如`JavaScript`中的`DOM`操作优化、图片优化以及`HTML`结构优化等等。在用户的角度，前端优化可以让页面加载得更快，对用户的操作响应更及时，能够给用户提供更友好的体验，在服务商的角度，前端优化能够减少页面请求数，见笑请求所占用宽带，能够节省服务器资源。

## 减少HTTP请求
加载前端的大部分时间在于下载各种资源，浏览器对于同一个服务器的`HTTP`请求连接池数量是有限的，对于过多的请求需要排队等待，最小化`HTTP`请求，减少请求次数可以防止`HTTP`连接池被占满，同时也能避免过多`HTTP`连接时的`TCP`握手造成的时间消耗。

### CSS Sprite
`CSS Sprite`精灵图，将多张图片合并到一张图片中，可以减少图片的数量，需要使用`CSS`的`background-image`和`background-position`属性显示所需的图像段。

### Image maps
假如网站有很多带链接的图片例如地图应用等，那么图片映射`image maps`将是一个很好的选择，`image maps`允许在单张图片上有很多带链接的图片，通过`<map>`与`<area>`来将一张完整的图片映射分割为多个区域来制作不同的链接，同样是可以减少图片的`HTTP`请求链接数量。

### Inline images
通过使用`data:URL`方案来直接将图像数据嵌入到页面或者`CSS`中，虽然这会增加文档或者是`CSS`文件的大小，但同样这确实是一个减少`HTTP`请求数量的方案，对于`data:URL`的格式为`data:[<mediatype>][;base64],<data>`。

### Font icon
使用字体图标来代替图标，将多个图标合成为字体图标不仅可以减少对于图片的`HTTP`请求数量与图标大小，还作为矢量图对于放大缩小等操作不会失真，此外字体图标的优点还包括其很容易改变颜色、产生阴影、透明效果等，可以得到`CSS`的很好的支持从而制作各种样式、旋转和动画效果等。

### Combined files
`Combined files`也就是合并文件，将多个`CSS`文件或者`JavaScript`文件合并成一个`CSS`文件或者`JavaScript`文件，可以有效减少`HTTP`请求数量，并且可以通过压缩算法减小文件的大小。当脚本和样式表在页面之间变化时，组合文件可能会变得难以阅读和修改，但是将其作为发布过程的一部分可以缩短响应时间。

## 利用缓存机制

### 缓存控制
通过服务器端设置响应头的`Expires`与`Cache-Control`来设置资源组件过期时间以及过期策略，对于静态资源可以通过设置`Expires`为一个长期时间来实现永不过期策略，对于动态组件通过`Cache-Control`指定缓存机制来辅助浏览器处理条件请求。

### 外部引用
将`JavaScript`与`CSS`设置为外部文件引入而不是直接嵌入到`HTML`中，由于浏览器的缓存机制，外部文件可以通过浏览器的缓存引入而不需要每次请求重复请求同一个资源文件，使得浏览器在第二次打开页面速度会快很多。

## 优化资源加载

### 样式表位置
根据浏览器渲染的顺序，将`CSS`在`<head>`中引入或者嵌入，相对于将`CSS`放到`<body>`或者页面底部来说，可以使页面渲染速度加快，这对于页面内容比较丰富的网站或者网络链接较慢时相当重要。假如将样式表放置于底部，就会导致浏览器还未加载样式表就开始渲染页面，无法渐进式渲染页面而直接从无样式状态立即跳转到有样式状态，用户体验较差；此外有些浏览器可能会在`CSS`下载完成后才开始渲染页面，样式表放在下方会导致页面渲染推迟。

### 脚本位置
浏览器是可以并发请求的，这一特点使得其能够更快的加载资源，然而外部引入`JavaScript`脚本在加载时却会阻塞其他资源，例如在脚本加载完成之前，它后面的图片、样式以及其他脚本都处于阻塞状态，直到脚本加载完成后才会开始加载，原因之一是`Js`可能会改变页面或者改变`Js`间的依赖关系，例如`A.js`中用`document.write`改变页面，`B.js`依赖`A.js`。因此要严格保证顺序，不能并行下载。如果将脚本放在比较靠前的位置，则会影响整个页面的加载速度从而影响用户体验。此外当浏览器发现`Js`脚本时浏览器会立即开始解析脚本，并停止解析文档，因为脚本有可能会改动`DOM`与`CSS`，继续解析会浪费资源。解决这些问题的方法有很多例如异步加载脚本等，而最简单可依赖的方法就是将脚本尽可能的往后挪，减少对并发下载与页面渲染的影响。

## 优化代码方案

### 避免CSS表达式
`CSS`表达式通过`expression`方法来接受`JavaScript`表达式，是一种动态设置`CSS`的强大的方式，但同样也是非常危险的方式，`CSS`表达式的问题在于其会进行频繁的计算，`CSS`计算的频率要远远超出我们的想象，不仅在页面显示和缩放时会进行计算，在页面滚动或者移动鼠标都会重新计算一次，从而影响到页面的性能。可以通过使用`Js`将属性进行一次算来并赋值给样式属性，也就是一次性表达式，如果必须在页面的整个生命周期中动态设置样式属性，则可以使用事件处理程序代替`CSS`表达式。如果必须使用`CSS`表达式，需要注意它们可能会被计算数千次，并且很可能会影响页面的性能。

### 避免重定向
尽量避免使用重定向，当页面发生了重定向，就会延迟整个`HTML`文档的传输。在`HTML`文档到达之前，页面中不会呈现任何东西，也没有任何组件会被下载，降低了用户体验。如果一定要使用重定向，如`http`重定向到`https`，要使用`301`永久重定向，而不是`302`临时重定向。因为如果使用`302`，则每一次访问`http`，都会被重定向到`https`的页面，而永久重定向，在第一次从`http`重定向到`https`之后就会被浏览器记住，每次访问`http`，会直接返回`https`的页面。

### 最小化操作DOM
`JavaScript`操作`DOM`无可避免的会触发浏览器的重绘或者回流，由于重绘和回流可能代价比较昂贵，因此最好就是可以减少它的发生次数，为了减少发生次数，我们可以合并多次对`DOM`和样式的修改，然后一次处理掉，或者将样式事先设计好，动态去改变`class`。或者采用离线修改`DOM`的方案，使用`documentFragment`对象在内存里操作`DOM`，在内存中的`DOM`修改就是让元素脱离文档流，当然是不会触发重绘的，将对`DOM`的所有修改批量完成，想怎么改就怎么改，然后将节点再放入文档流中，只触发一次回流。

## 压缩资源文件

### Gzip
从`HTTP / 1.1`开始，客户端可以通过使用`HTTP`请求中的`Accept-Encoding: gzip, deflate`来指示对压缩的支持。如果服务器在请求中看到此标头，则可以使用客户端列出的方法之一压缩响应，服务器通过响应中的`Content-Encoding: gzip`通知客户端采用`gzip`压缩。`Gzip`的压缩率很高，是目前最流行，最有效的压缩方法，它由`GNU`项目开发，并由`RFC 1952`标准化。

### 压缩外部文件
压缩`JavaScript`和`CSS`文件，从代码中删除不必要的字符以减小其大小，从而缩短加载时间，当代码最小化时，所有注释以及不需要的空白字符都将被删除，由于减小了下载文件的大小，因此可以提高响应时间性能。

## 优化网络请求

### CDN
内容分发网络，静态资源就近获取所需内容。

### DNS预解析
`DNS`预解析就是根据浏览器定义的规则，提前解析之后可能会用到的域名，使解析结果缓存到系统缓存中，缩短`DNS`解析时间，来提高网站的访问速度